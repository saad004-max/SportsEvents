@page "/tournaments/{Id:int}"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Authorization

<div class="container" style="max-width: 1000px; margin: 40px auto;">

    @if (tournoi == null)
    {
        <div style="text-align: center; margin-top: 50px;">
            <div class="spinner-border text-primary" role="status"></div>
            <p style="color: var(--text-muted); margin-top: 10px;">Loading details...</p>
        </div>
    }
    else
    {
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
            <div>
                <h1 style="font-size: 3rem; margin: 0; text-transform: uppercase;">@tournoi.Nom</h1>
                <span class="badge-live" style="font-size: 1rem; margin-top: 10px; display: inline-block;">
                    @tournoi.Statut
                </span>
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-start;">

                <AuthorizeView Roles="Admin, Organizer">
                    <Authorized>
                        @if (tournoi.Statut == "Brouillon")
                        {
                            <button class="btn-sport" @onclick="PublishTournament" style="background-color: var(--accent-sport); color: black; font-weight: bold;">
                                🚀 Publish / Start
                            </button>
                        }
                    </Authorized>
                </AuthorizeView>

                <a href="/tournaments/@Id/bracket" class="btn-primary-sport" style="text-decoration: none;">
                    <span>👁 View Bracket</span>
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="sport-card">
                    <h3 style="color: var(--accent-secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Info</h3>

                    <div style="margin-bottom: 15px;">
                        <span style="color: var(--text-muted); display: block; font-size: 0.85rem;">SPORT</span>
                        <span style="font-size: 1.1rem; font-weight: bold; text-transform: uppercase;">@tournoi.Sport</span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <span style="color: var(--text-muted); display: block; font-size: 0.85rem;">LOCATION</span>
                        <span style="font-size: 1.1rem;">📍 @tournoi.Lieu</span>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <span style="color: var(--text-muted); display: block; font-size: 0.85rem;">DATES</span>
                        <span>@tournoi.DateDebut.ToShortDateString() - @tournoi.DateFin.ToShortDateString()</span>
                    </div>

                    <div>
                        <span style="color: var(--text-muted); display: block; font-size: 0.85rem;">TEAMS</span>
                        <span style="color: var(--accent-sport); font-weight: bold;">
                            @(teams?.Count ?? 0) / @tournoi.NombreEquipesMax
                        </span>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="sport-card">

                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 15px;">
                        <h3 style="color: white; margin-bottom: 0;">Participating Teams</h3>

                        <AuthorizeView Roles="Admin, Organizer">
                            <Authorized>
                                @if (tournoi.Statut == "Brouillon")
                                {
                                    <a href="/tournaments/@Id/add-team" class="btn-sport" style="font-size: 0.8rem; text-decoration: none; padding: 5px 15px;">
                                        ➕ Add Team
                                    </a>
                                }
                            </Authorized>
                        </AuthorizeView>
                    </div>

                    @if (teams == null || teams.Count == 0)
                    {
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            No teams registered yet.
                        </div>
                    }
                    else
                    {
                        <table class="table-sport">
                            <thead>
                                <tr>
                                    <th>Logo</th>
                                    <th>Name</th>
                                    <th style="text-align: right;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var team in teams)
                                {
                                    <tr>
                                        <td style="width: 50px;">
                                            @if (!string.IsNullOrEmpty(team.Logo))
                                            {
                                                <img src="@team.Logo" alt="@team.Nom"
                                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #333;"
                                                     onerror="this.style.display='none'" />
                                            }
                                            else
                                            {
                                                <div style="width: 40px; height: 40px; background-color: var(--accent-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold;">
                                                    @(string.IsNullOrEmpty(team.Nom) ? "?" : team.Nom.Substring(0, 1).ToUpper())
                                                </div>
                                            }
                                        </td>

                                        <td style="font-weight: bold; font-size: 1.1rem; vertical-align: middle;">
                                            @team.Nom
                                        </td>

                                        <td style="text-align: right; vertical-align: middle;">
                                            <AuthorizeView Roles="Admin, Organizer">
                                                <Authorized>
                                                    @if (tournoi.Statut == "Brouillon")
                                                    {
                                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteTeam(team.Id)" title="Remove Team" style="border: 1px solid #ff4444; color: #ff4444; background: transparent;">
                                                            🗑
                                                        </button>
                                                    }
                                                </Authorized>
                                            </AuthorizeView>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private TournamentDto? tournoi;
    private List<TeamDto>? teams;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            tournoi = await Http.GetFromJsonAsync<TournamentDto>($"api/Tournoi/{Id}");
            teams = await Http.GetFromJsonAsync<List<TeamDto>>($"api/Tournoi/{Id}/teams");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private async Task PublishTournament()
    {
        if (teams == null || teams.Count < 2)
        {
            await JS.InvokeVoidAsync("alert", "You need at least 2 teams to publish!");
            return;
        }

        var response = await Http.PatchAsync($"api/Tournoi/{Id}/publier", null);
        if (response.IsSuccessStatusCode)
        {
            await LoadData();
        }
    }

    // [NEW] Delete Team Logic
    private async Task DeleteTeam(int teamId)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to remove this team?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/Equipe/{teamId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadData(); // Refresh to remove the deleted team
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to delete team.");
            }
        }
    }

    public class TournamentDto
    {
        public int Id { get; set; }
        public string Nom { get; set; } = "";
        public string Sport { get; set; } = "";
        public string Lieu { get; set; } = "";
        public string Statut { get; set; } = "Open";
        public DateTime DateDebut { get; set; }
        public DateTime DateFin { get; set; }
        public int NombreEquipesMax { get; set; }
    }

    public class TeamDto
    {
        public int Id { get; set; } // [IMPORTANT] Added Id so we can delete it
        public string Nom { get; set; } = "";
        public string Logo { get; set; } = "";
    }
}