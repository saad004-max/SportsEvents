@page "/login"
@using SportsEventsUI.Auth
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<div class="container" style="max-width: 500px; margin: 60px auto;">

    <h1 style="text-align:center; margin-bottom: 20px;">
        WELCOME <span style="color: var(--accent-sport);">BACK</span>
    </h1>

    <div class="sport-card">
        <div style="margin-bottom: 20px;">
            <label style="display: block; color: var(--text-muted); margin-bottom: 8px;">Email</label>
            <input @bind="loginRequest.Email" placeholder="admin@sportsevents.com"
                   style="width: 100%; padding: 12px; background: #2a2a35; border: 1px solid #444; color: white; border-radius: 8px;" />
        </div>

        <div style="margin-bottom: 30px;">
            <label style="display: block; color: var(--text-muted); margin-bottom: 8px;">Password</label>
            <input type="password" @bind="loginRequest.Password" placeholder="••••••••"
                   style="width: 100%; padding: 12px; background: #2a2a35; border: 1px solid #444; color: white; border-radius: 8px;" />
        </div>

        <button class="btn-primary-sport" style="width: 100%;" @onclick="HandleLogin">
            <span>Sign In</span>
        </button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="margin-top: 15px; padding: 10px; border-radius: 4px; background: rgba(255,71,87,0.1); border: 1px solid var(--danger); color: var(--danger); text-align: center;">
                @errorMessage
            </div>
        }

        <div style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <span style="color: var(--text-muted);">New player? </span>
            <a href="/register" style="color: var(--accent-secondary); text-decoration: none; font-weight: bold;">Create an Account</a>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new LoginRequest();
    private string? errorMessage;

    private async Task HandleLogin()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/Auth/login", loginRequest);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResult>();
                if (result != null)
                {
                    await LocalStorage.SetItemAsync("authToken", result.Token);
                    ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(result.Token);
                    NavManager.NavigateTo("/");
                }
            }
            else
            {
                errorMessage = "Invalid email or password.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Server connection failed.";
            Console.WriteLine(ex.Message);
        }
    }

    public class LoginRequest
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }

    public class LoginResult
    {
        public string Token { get; set; } = "";
    }
}