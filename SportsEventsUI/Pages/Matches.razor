@page "/matches"
@inject HttpClient Http
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization

<div class="container" style="max-width: 900px; margin: 40px auto; padding: 20px;">

    <h1>Match <span style="color: var(--accent-sport);">Schedule</span></h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (matches == null && string.IsNullOrEmpty(errorMessage))
    {
        <p style="color: var(--text-muted);">Loading matches...</p>
    }
    else if (matches != null && matches.Count == 0)
    {
        <p style="color: var(--text-muted);">No matches found.</p>
    }
    else if (matches != null)
    {
        @foreach (var match in matches)
        {
            <div class="sport-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span class="badge-live">Match #@match.id</span>
                    <span style="color: var(--text-muted); font-size: 0.9rem;">@match.tournoiName • @match.lieu</span>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="text-align: center; flex: 1;">
                        <h3 style="margin: 0;">@match.homeTeam</h3>
                        <small style="color: var(--text-muted);">Home</small>
                    </div>

                    <div style="background: #000; padding: 15px 30px; border-radius: 8px; font-family: monospace; font-size: 2rem; color: var(--accent-sport); border: 1px solid #333;">
                        @match.scoreDomicile - @match.scoreExterieur
                    </div>

                    <div style="text-align: center; flex: 1;">
                        <h3 style="margin: 0;">@match.awayTeam</h3>
                        <small style="color: var(--text-muted);">Away</small>
                    </div>
                </div>

                <AuthorizeView Roles="Admin, Organizer">
                    <Authorized>
                        <div style="margin-top: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <a href="/matches/@match.id/update" class="btn-sport" style="text-decoration: none; font-size: 0.9rem;">
                                ✎ Update Result
                            </a>
                        </div>
                    </Authorized>
                </AuthorizeView>

            </div>
        }
    }
</div>

@code {
    private List<MatchListDto>? matches;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("api/Match");

            if (response.IsSuccessStatusCode)
            {
                var jsonString = await response.Content.ReadAsStringAsync();

                if (!string.IsNullOrEmpty(jsonString))
                {
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    matches = JsonSerializer.Deserialize<List<MatchListDto>>(jsonString, options);
                }
            }
            else
            {
                errorMessage = $"Server Error: {response.StatusCode}";
                Console.WriteLine($"API Failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Critical Error: {ex.Message}";
            Console.WriteLine($"Exception: {ex}");
        }
    }

    public class MatchListDto
    {
        public int id { get; set; }
        public DateTime dateMatch { get; set; }
        public string lieu { get; set; } = "";
        public string tournoiName { get; set; } = "";
        public string homeTeam { get; set; } = "Unknown";
        public string awayTeam { get; set; } = "Unknown";
        public int scoreDomicile { get; set; }
        public int scoreExterieur { get; set; }
    }
}